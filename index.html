<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editable Attendance Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }

        button, a {
            padding: 5px 10px;
        }

        .attendance {
            background-color: #4CAF50;
            color: white;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .editable-title {
            background-color: #f2f2f2;
            cursor: text;
        }
    </style>
</head>
<body>

<h2>Editable Attendance Table</h2>

<div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search..." onkeyup="searchTable()">
</div>

<table id="attendanceTable">
    <thead>
        <tr>
            <th contenteditable="true" class="editable-title" onblur="updateColumnTitle('Name', this.innerText)">Name</th>
            <th contenteditable="true" class="editable-title" onblur="updateColumnTitle('Class', this.innerText)">Class</th>
            <th contenteditable="true" class="editable-title" onblur="updateColumnTitle('Subject', this.innerText)">Subject</th>
            <th>Attendance</th>
            <th>Action</th>
            <th>Copy Link</th>
            <th>Undo Attendance</th>
        </tr>
    </thead>
    <tbody id="attendanceBody">
        <!-- Rows will be populated here -->
    </tbody>
</table>

<br>
<button onclick="addRow()">Add Row</button>
<button onclick="deleteRow()">Delete Last Row</button>

<script>
    const apiUrl = 'http://localhost:5000/attendance'; // Change this to your server URL

    // Load attendance from the server
    async function loadAttendance() {
        const response = await fetch(apiUrl);
        const records = await response.json();
        const tableBody = document.getElementById('attendanceBody');
        tableBody.innerHTML = '';

        records.forEach(record => {
            const newRow = tableBody.insertRow(-1);
            const nameCell = newRow.insertCell(0);
            const classCell = newRow.insertCell(1);
            const subjectCell = newRow.insertCell(2);
            const attendanceCell = newRow.insertCell(3);
            const actionCell = newRow.insertCell(4);
            const copyCell = newRow.insertCell(5);
            const undoCell = newRow.insertCell(6);

            nameCell.contentEditable = "true";
            classCell.contentEditable = "true";
            subjectCell.contentEditable = "true";
            attendanceCell.id = record._id;
            attendanceCell.innerText = record.attendance;

            // Event listeners for saving changes
            nameCell.onblur = () => updateCell(record._id, 'name', nameCell.innerText);
            classCell.onblur = () => updateCell(record._id, 'class', classCell.innerText);
            subjectCell.onblur = () => updateCell(record._id, 'subject', subjectCell.innerText);

            actionCell.innerHTML = `<a href="#" onclick="markAttendance('${record._id}')">Mark Attendance</a>`;
            copyCell.innerHTML = `<button onclick="copyLink('${record._id}')">Copy Link</button>`;
            undoCell.innerHTML = `<button onclick="undoAttendance('${record._id}')">Undo Attendance</button>`;
        });
    }

    async function addRow() {
        const newRow = {
            name: "New Name",
            class: "New Class",
            subject: "New Subject",
            attendance: "Absent"
        };
        
        await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newRow)
        });

        loadAttendance();
    }

    async function markAttendance(id) {
        await fetch(`${apiUrl}/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ attendance: 'Present' })
        });
        loadAttendance();
    }

    async function undoAttendance(id) {
        await fetch(`${apiUrl}/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ attendance: 'Absent' })
        });
        loadAttendance();
    }

    async function deleteRow() {
        const tableBody = document.getElementById('attendanceBody');
        const lastRow = tableBody.lastElementChild;
        if (lastRow) {
            const id = lastRow.cells[3].id; // Get the ID from the attendance cell
            await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
            loadAttendance();
        }
    }

    function copyLink(id) {
        const link = `${window.location.origin}/markAttendance/${id}`;
        const tempInput = document.createElement("input");
        document.body.appendChild(tempInput);
        tempInput.value = link;
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        alert("Link copied: " + link);
    }

    async function updateCell(id, field, value) {
        await fetch(`${apiUrl}/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ [field]: value })
        });
    }

    async function updateColumnTitle(oldTitle, newTitle) {
        // This function is a placeholder since we won't be saving column titles to the backend.
        console.log(`Column '${oldTitle}' updated to '${newTitle}'`);
    }

    function searchTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('attendanceTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let found = false;

            for (let j = 0; j < cells.length - 3; j++) { // Ignore the last three columns (Attendance, Action, Copy Link, Undo Attendance)
                if (cells[j].innerText.toLowerCase().includes(filter)) {
                    found = true;
                    break;
                }
            }

            rows[i].style.display = found ? '' : 'none';
        }
    }

    window.onload = loadAttendance;
</script>

</body>
</html>
