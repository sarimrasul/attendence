<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editable Attendance Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }

        button, a {
            padding: 5px 10px;
        }

        .attendance {
            background-color: #4CAF50;
            color: white;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .editable-title {
            background-color: #f2f2f2;
            cursor: text;
        }
    </style>
</head>
<body>

<h2>Editable Attendance Table</h2>

<div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search..." onkeyup="searchTable()">
</div>

<table id="attendanceTable">
    <thead>
        <tr>
            <th contenteditable="true" class="editable-title" onblur="updateColumnTitle('Name', this.innerText)">Name</th>
            <th contenteditable="true" class="editable-title" onblur="updateColumnTitle('Class', this.innerText)">Class</th>
            <th contenteditable="true" class="editable-title" onblur="updateColumnTitle('Subject', this.innerText)">Subject</th>
            <th>Attendance</th>
            <th>Action</th>
            <th>Copy Link</th>
            <th>Undo Attendance</th>
        </tr>
    </thead>
    <tbody id="attendanceBody">
        <!-- Rows will be populated here -->
    </tbody>
</table>

<br>
<button onclick="addRow()">Add Row</button>
<button onclick="deleteRow()">Delete Last Row</button>

<script>
    // Load attendance from localStorage
    function loadAttendance() {
        const records = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        const tableBody = document.getElementById('attendanceBody');
        tableBody.innerHTML = '';

        records.forEach((record, index) => {
            const newRow = tableBody.insertRow(-1);
            const nameCell = newRow.insertCell(0);
            const classCell = newRow.insertCell(1);
            const subjectCell = newRow.insertCell(2);
            const attendanceCell = newRow.insertCell(3);
            const actionCell = newRow.insertCell(4);
            const copyCell = newRow.insertCell(5);
            const undoCell = newRow.insertCell(6);

            nameCell.contentEditable = "true";
            classCell.contentEditable = "true";
            subjectCell.contentEditable = "true";
            attendanceCell.innerText = record.attendance;

            // Event listeners for saving changes
            nameCell.onblur = () => updateCell(index, 'name', nameCell.innerText);
            classCell.onblur = () => updateCell(index, 'class', classCell.innerText);
            subjectCell.onblur = () => updateCell(index, 'subject', subjectCell.innerText);

            actionCell.innerHTML = `<button onclick="markAttendance(${index})">Mark Attendance</button>`;
            copyCell.innerHTML = `<button onclick="copyLink(${index})">Copy Link</button>`;
            undoCell.innerHTML = `<button onclick="undoAttendance(${index})">Undo Attendance</button>`;
        });
    }

    function addRow() {
        const newRow = {
            name: "New Name",
            class: "New Class",
            subject: "New Subject",
            attendance: "Absent"
        };
        
        const records = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        records.push(newRow);
        localStorage.setItem('attendanceRecords', JSON.stringify(records));
        loadAttendance();
    }

    function markAttendance(index) {
        const records = JSON.parse(localStorage.getItem('attendanceRecords'));
        records[index].attendance = 'Present';
        localStorage.setItem('attendanceRecords', JSON.stringify(records));
        loadAttendance();
    }

    function undoAttendance(index) {
        const records = JSON.parse(localStorage.getItem('attendanceRecords'));
        records[index].attendance = 'Absent';
        localStorage.setItem('attendanceRecords', JSON.stringify(records));
        loadAttendance();
    }

    function deleteRow() {
        const records = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        if (records.length > 0) {
            records.pop(); // Remove the last record
            localStorage.setItem('attendanceRecords', JSON.stringify(records));
            loadAttendance();
        }
    }

    function copyLink(index) {
        const link = `${window.location.href}?attendanceId=${index}`;
        const tempInput = document.createElement("input");
        document.body.appendChild(tempInput);
        tempInput.value = link;
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        alert("Link copied: " + link);
    }

    function updateCell(index, field, value) {
        const records = JSON.parse(localStorage.getItem('attendanceRecords'));
        records[index][field] = value;
        localStorage.setItem('attendanceRecords', JSON.stringify(records));
    }

    function updateColumnTitle(oldTitle, newTitle) {
        // This function is a placeholder since we won't be saving column titles to the backend.
        console.log(`Column '${oldTitle}' updated to '${newTitle}'`);
    }

    function searchTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('attendanceTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let found = false;

            for (let j = 0; j < cells.length - 3; j++) { // Ignore the last three columns (Attendance, Action, Copy Link, Undo Attendance)
                if (cells[j].innerText.toLowerCase().includes(filter)) {
                    found = true;
                    break;
                }
            }

            rows[i].style.display = found ? '' : 'none';
        }
    }

    window.onload = loadAttendance;
</script>

</body>
</html>
